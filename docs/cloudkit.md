# データ永続化のアーキテクチャ変更

## 変更前のデータ永続化のアーキテクチャ
UI(Popup, Content Script Context Menu) -- メッセージパッシング (browser.runtime.sendMessage) --> Background.js(Message Handler) --> サービスレイヤー(StorageManager) --> データ永続化層(browser.storage.local API)という流れでデータの永続化に対応していました。

┌──────────────────────────────────────────────────────┐
│                 ユーザーインターフェース                │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   Popup    │  │Content Script│  │Context Menu │ │
│  │  (400x600) │  │  (iOS button)│  │   (macOS)   │ │
│  └────────────┘  └──────────────┘  └─────────────┘ │
└──────────────────────────────────────────────────────┘
                            │
                    メッセージパッシング
                    (browser.runtime)
                            ▼
┌──────────────────────────────────────────────────────┐
│              Background Service Worker                │
│  ┌──────────────────────────────────────────────┐   │
│  │            Message Handler                    │   │
│  │    メッセージを適切なサービスにルーティング        │   │
│  └──────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────┐
│                                                      │
│                                         ┌────────┐   │
│                                         │Storage │   │
│                                         │Manager │   │
│                                         └────────┘   │
└──────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────┐
│                  データ永続化層                        │
│              browser.storage.local API                │
└──────────────────────────────────────────────────────┘

## 変更後のアーキテクチャ
このデータ永続化をSwiftData+CloudKitに置き換えます。これによりbrowser.storage.localの制限を回避し、iOSとmacOSのデータの共有も可能になります。
変更後のアーキテクチャの詳細はdocs/db-architecture.mdを参照してください。



## 現状のステータス
* VocabularyListの取得・作成, VocabularyListへの単語の追加についてはCloudKit + SwiftDataに移行済みで動作確認済みです。

## 依頼
* データの永続化が必要なものを洗い出してください。既存でStorageManagerで実装されているものが対象です。RecentSearchは重要度が低いので一旦除外で良いです。
※ mainブランチとのdiffなども参考になるかもです。
* 操作の種類についても既存で実装されているものだけで一旦良いです。message-handler.jsのMessageTypeなどが参考になるかもしれません。
* それらのデータをSwiftData+CloudKitで永続化するためのプランニングを行なってください。既存のVocabularyListの取得に関する実装やdocs/db-architecture.mdを参考にしてください。
* 一つの機能ずつ最後まで実装をお願いします。つまり全部のModelsを作って・・・次に・・・とソースコード毎に順に作成するのではなく、１機能のmodelを作って・・・・1機能の全てを完遂させてから次の機能に行ってください。
