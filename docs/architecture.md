# VocabDict アーキテクチャ

## 概要

VocabDictは、英語学習者向けのSafari Web Extensionです。統合された辞書検索、語彙管理、間隔反復学習を通じて語彙力向上を支援します。

## コアアーキテクチャ

```
┌──────────────────────────────────────────────────────┐
│                 ユーザーインターフェース                │
│  ┌────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │   Popup    │  │Content Script│  │Context Menu │ │
│  │  (400x600) │  │  (iOS button)│  │   (macOS)   │ │
│  └────────────┘  └──────────────┘  └─────────────┘ │
└──────────────────────────────────────────────────────┘
                            │
                    メッセージパッシング
                    (browser.runtime)
                            ▼
┌──────────────────────────────────────────────────────┐
│              Background Service Worker                │
│  ┌──────────────────────────────────────────────┐   │
│  │            Message Handler                    │   │
│  │    メッセージを適切なサービスにルーティング        │   │
│  └──────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────┐
│                   サービスレイヤー                      │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │Dictionary│ │Vocabulary│ │  Spaced  │ │Storage │ │
│  │ Service  │ │   List   │ │Repetition│ │Manager │ │
│  └──────────┘ └──────────┘ └──────────┘ └────────┘ │
└──────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────┐
│                  データ永続化層                        │
│              browser.storage.local API                │
└──────────────────────────────────────────────────────┘
```

## コンポーネントの責務

### UIレイヤー
- **Popup**: 4つのタブ（検索、リスト、学習、設定）を持つメインインターフェース
  - src/popup/内のファイルに実装されている
- **Content Script**: Webページ上のテキスト選択を処理（iOS向け）
  - src/content/に実装されている。
- **Context Menu**: 右クリックによる単語検索（macOS向け）
  - Context Menu自体はsrc/background/background.jsで作成している。

### バックグラウンドレイヤー（src/background）
- **Service Worker**: 中央メッセージハブとサービスコーディネーター
- **Message Handler**: メッセージをサービスにルーティング、一貫したレスポンス形式を維持

### サービスレイヤー（src/services）
- **DictionaryService**: 単語の定義、発音、同義語/反意語
- **VocabularyList**: ユーザー語彙のCRUD操作と管理
- **SpacedRepetition**: 学習アルゴリズムと復習スケジューリング
- **StorageManager**: browser.storage.localの抽象化

## データアーキテクチャ

### メッセージフォーマット
```javascript
// リクエスト
{ type: MESSAGE_TYPE, ...params }

// レスポンス
{ success: boolean, data?: any, error?: string }
```

## 主要な設計決定

1. **メッセージ駆動型通信**: 疎結合のため、全コンポーネントはbrowser.runtimeメッセージで通信
2. **サービス指向アーキテクチャ**: ビジネスロジックをサービスモジュールに分離
3. **デトロイト派TDD**: 意味のあるテストのため、モックより実装を使用
4. **辞書データを信頼できる情報源に**: 単語定義はユーザーデータに複製しない
5. **依存性注入**: テスタビリティのため、サービスをパラメータとして渡す

## ビルドパイプライン

```
src/                          webpack                    Xcode
 ├─ background/ ──────────┐                         ┌──> macOS app
 ├─ content/ ─────────────┼──> Resources/ ─────────┤
 ├─ popup/ ───────────────┘                         └──> iOS app
 └─ services/
```

## プラットフォーム考慮事項

### Safari Extension の制限
- ES6モジュール非対応（webpackバンドル必須）
- Chrome拡張機能と比較してAPI制限あり
- 手動テーマ選択（自動検出なし）
- ストレージクォータ制限

### iOS vs macOS
- **iOS**: テキスト選択ボタンUI
- **macOS**: コンテキストメニュー統合
- プラットフォーム固有機能を持つ共有コードベース
