(()=>{console.log("VocabDict content script loaded");let t=null,n=null;async function e(t,n){const d=document.createElement("div");d.className="vocabdict-overlay loading";let a=n.top-200,c=n.left+n.width/2-140;a<20&&(a=n.bottom+20),c<20&&(c=20),c+280>window.innerWidth-20&&(c=window.innerWidth-300),a+=window.scrollY,c+=window.scrollX,d.style.top=`${a}px`,d.style.left=`${c}px`,d.innerHTML=`\n    <div class="vocabdict-overlay-content">\n      <div class="loading-spinner"></div>\n      <div class="loading-text">Looking up "${t}"...</div>\n    </div>\n  `,document.body.appendChild(d);try{const n=await browser.runtime.sendMessage({type:"lookup_word",word:t});n.success?n.data?function(t,n){t.className="vocabdict-overlay";const e=(Array.isArray(n.definitions)?n.definitions:[{partOfSpeech:"",meaning:n.definition}]).map(t=>`\n    <div class="definition-item">\n      ${t.partOfSpeech?`<div class="part-of-speech">${t.partOfSpeech}</div>`:""}\n      <div class="definition-text">${t.meaning||t.definition}</div>\n    </div>\n  `).join("");t.innerHTML=`\n    <div class="vocabdict-overlay-content">\n      <div class="word-title">${n.word}</div>\n      ${n.pronunciation?`<div class="word-pronunciation">${n.pronunciation}</div>`:""}\n      <div class="word-definitions">\n        ${e}\n      </div>\n    </div>\n    <div class="overlay-actions">\n      <button class="add-to-list-button">Add to List</button>\n      <button class="close-button">√ó</button>\n    </div>\n  `;t.querySelector(".add-to-list-button").addEventListener("click",async()=>{await async function(t){try{const n=await browser.runtime.sendMessage({type:"get_lists"});if(n.success&&n.data.length>0){const e=n.data[0].id,o=await browser.runtime.sendMessage({type:"add_to_list",word:t,listId:e,metadata:{difficulty:"medium",context:"Added from webpage"}});o.success?i(`Added "${t}" to vocabulary list`):i(`Failed to add "${t}": ${o.error}`)}else i("No vocabulary lists available")}catch(t){console.error("VocabDict: Error adding word to list",t),i("Failed to add word to list")}}(n.word)})}(d,n.data):n.suggestions&&n.suggestions.length>0?function(t,n,o){t.className="vocabdict-overlay";const i=o.map(t=>`\n    <span class="suggestion-item" data-word="${t}">${t}</span>\n  `).join("");t.innerHTML=`\n    <div class="vocabdict-overlay-content">\n      <div class="error-message">No definition found for "${n}"</div>\n      <div class="suggestions">\n        <div class="suggestions-title">Did you mean?</div>\n        ${i}\n      </div>\n    </div>\n    <div class="overlay-actions">\n      <button class="close-button">Close</button>\n    </div>\n  `,t.querySelectorAll(".suggestion-item").forEach(n=>{n.addEventListener("click",async()=>{const o=n.getAttribute("data-word");t.remove();const i=window.getSelection().getRangeAt(0).getBoundingClientRect();await e(o,i)})})}(d,t,n.suggestions):o(d,`No definition found for "${t}"`):o(d,n.error||"Failed to look up word")}catch(t){console.error("VocabDict: Error looking up word",t),o(d,"Failed to look up word")}!function(t){const n=t.querySelector(".close-button");n&&n.addEventListener("click",()=>{s(t)});const e=n=>{t.contains(n.target)||(s(t),document.removeEventListener("click",e))};document.addEventListener("click",e);const o=n=>{"Escape"===n.key&&(s(t),document.removeEventListener("keydown",o))};document.addEventListener("keydown",o)}(d)}function o(t,n){t.className="vocabdict-overlay",t.innerHTML=`\n    <div class="vocabdict-overlay-content">\n      <div class="error-message">${n}</div>\n    </div>\n    <div class="overlay-actions">\n      <button class="close-button">Close</button>\n    </div>\n  `}function i(t){const n=document.createElement("div");n.style.cssText='\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: #34C759;\n    color: white;\n    padding: 12px 16px;\n    border-radius: 8px;\n    font-size: 14px;\n    font-weight: 500;\n    z-index: 2147483647;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n  ',n.textContent=t,document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}function s(t){t.classList.add("closing"),setTimeout(()=>{t.remove(),window.getSelection().removeAllRanges()},150)}document.addEventListener("selectionchange",()=>{clearTimeout(n),n=setTimeout(()=>{!function(){const n=window.getSelection(),o=n.toString().trim();if(t&&(t.remove(),t=null),o&&o.length<=50&&o.split(/\s+/).length<=3)try{const i=n.getRangeAt(0).getBoundingClientRect();i.width>0&&i.height>0&&function(n,o){const i=document.createElement("button");i.className="vocabdict-lookup-button",i.textContent="üîç",i.setAttribute("aria-label",`Look up "${n}"`);let s=o.top-44-8,d=o.left+o.width/2-22;s<8&&(s=o.bottom+8),d<8&&(d=8),d+44>window.innerWidth-8&&(d=window.innerWidth-44-8),s+=window.scrollY,d+=window.scrollX,i.style.top=`${s}px`,i.style.left=`${d}px`,i.addEventListener("click",async s=>{s.preventDefault(),s.stopPropagation(),i.remove(),t=null,await e(n,o)}),document.body.appendChild(i),t=i}(o,i)}catch(t){console.error("VocabDict: Error handling selection",t)}}()},300)}),window.addEventListener("pagehide",()=>{t&&t.remove()})})();